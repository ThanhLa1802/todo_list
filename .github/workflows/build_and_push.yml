name: Full Stack Todo List CICD (Master Branch)

# KÃ­ch hoáº¡t workflow khi cÃ³ push lÃªn nhÃ¡nh 'master'
on:
  push:
    branches: [ "master" ]
  # Cho phÃ©p cháº¡y workflow thá»§ cÃ´ng tá»« GitHub UI
  workflow_dispatch:

# Äá»‹nh nghÄ©a cÃ¡c cÃ´ng viá»‡c (jobs) sáº½ cháº¡y
jobs:
  build_and_push:
    # Chá»n há»‡ Ä‘iá»u hÃ nh Ä‘á»ƒ cháº¡y job
    runs-on: ubuntu-latest

    # CÃ¡c biáº¿n mÃ´i trÆ°á»ng sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng trong bÆ°á»›c build
    env:
      # QUAN TRá»ŒNG: Äáº·t giÃ¡ trá»‹ máº·c Ä‘á»‹nh cho biáº¿n API URL. 
      # Náº¿u BE vÃ  FE cháº¡y cÃ¹ng má»™t cá»•ng/tÃªn miá»n, sá»­ dá»¥ng Ä‘Æ°á»ng dáº«n tÆ°Æ¡ng Ä‘á»‘i lÃ  tá»‘t nháº¥t.
      # VÃ­ dá»¥: /api náº¿u báº¡n dÃ¹ng Nginx/Proxy Ä‘á»ƒ chuyá»ƒn hÆ°á»›ng, hoáº·c tÃªn miá»n Ä‘áº§y Ä‘á»§.
      DEFAULT_API_URL: /

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up Docker Buildx
        # Thiáº¿t láº­p Docker Buildx Ä‘á»ƒ build image hiá»‡u quáº£
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Log in to Docker Hub
        # ÄÄƒng nháº­p vÃ o Docker Hub báº±ng secrets Ä‘Ã£ thiáº¿t láº­p
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ·ï¸ Extract metadata (tags) for Docker
        # Tá»± Ä‘á»™ng táº¡o tÃªn vÃ  tags cho image
        id: meta
        uses: docker/metadata-action@v5
        with:
          # Thay tháº¿ 'todo-list-v2' báº±ng tÃªn image báº¡n muá»‘n
          images: ${{ secrets.DOCKER_USERNAME }}/todo-list-v2 
          tags: |
            # 1. Tháº» 'latest' (chá»‰ gáº¯n tháº» nÃ y khi Ä‘ang á»Ÿ nhÃ¡nh master)
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/master' }}
            # 2. Tháº» dá»±a trÃªn SHA ngáº¯n cá»§a commit
            type=sha,prefix=

      - name: ğŸ—ï¸ Build and Push Docker image
        # XÃ¢y dá»±ng image vÃ  Ä‘áº©y lÃªn Docker Hub
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Truyá»n biáº¿n mÃ´i trÆ°á»ng API_URL cho Stage Build Frontend
          build-args: |
            REACT_APP_API_URL=${{ env.DEFAULT_API_URL }}