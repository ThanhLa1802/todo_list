name: Full Stack Todo List CICD (Master Branch)

# K√≠ch ho·∫°t workflow khi c√≥ push l√™n nh√°nh 'master'
on:
  push:
    branches: [ "master" ]
  # Cho ph√©p ch·∫°y workflow th·ªß c√¥ng t·ª´ GitHub UI
  workflow_dispatch:

# ƒê·ªãnh nghƒ©a c√°c c√¥ng vi·ªác (jobs) s·∫Ω ch·∫°y
jobs:
  build_and_push:
    # Ch·ªçn h·ªá ƒëi·ªÅu h√†nh ƒë·ªÉ ch·∫°y job
    runs-on: ubuntu-latest

    # C√°c bi·∫øn m√¥i tr∆∞·ªùng s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng trong b∆∞·ªõc build
    env:
      # QUAN TR·ªåNG: ƒê·∫∑t gi√° tr·ªã m·∫∑c ƒë·ªãnh cho bi·∫øn API URL. 
      # N·∫øu BE v√† FE ch·∫°y c√πng m·ªôt c·ªïng/t√™n mi·ªÅn, s·ª≠ d·ª•ng ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi l√† t·ªët nh·∫•t.
      # V√≠ d·ª•: /api n·∫øu b·∫°n d√πng Nginx/Proxy ƒë·ªÉ chuy·ªÉn h∆∞·ªõng, ho·∫∑c t√™n mi·ªÅn ƒë·∫ßy ƒë·ªß.
      DEFAULT_API_URL: /

    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Set up Docker Buildx
        # Thi·∫øt l·∫≠p Docker Buildx ƒë·ªÉ build image hi·ªáu qu·∫£
        uses: docker/setup-buildx-action@v3

      - name: üîë Log in to Docker Hub
        # ƒêƒÉng nh·∫≠p v√†o Docker Hub b·∫±ng secrets ƒë√£ thi·∫øt l·∫≠p
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üè∑Ô∏è Extract metadata (tags) for Docker
        # T·ª± ƒë·ªông t·∫°o t√™n v√† tags cho image
        id: meta
        uses: docker/metadata-action@v5
        with:
          # Thay th·∫ø 'todo-list-v2' b·∫±ng t√™n image b·∫°n mu·ªën
          images: ${{ secrets.DOCKER_USERNAME }}/todo-list-v2 
          tags: |
            # 1. Th·∫ª 'latest' (ch·ªâ g·∫Øn th·∫ª n√†y khi ƒëang ·ªü nh√°nh master)
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/master' }}
            # 2. Th·∫ª d·ª±a tr√™n SHA ng·∫Øn c·ªßa commit
            type=sha,prefix=

      - name: üèóÔ∏è Build and Push Docker image
        # X√¢y d·ª±ng image v√† ƒë·∫©y l√™n Docker Hub
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Truy·ªÅn bi·∫øn m√¥i tr∆∞·ªùng API_URL cho Stage Build Frontend
          build-args: |
            REACT_APP_API_URL=${{ env.DEFAULT_API_URL }}

  # ... (Ph·∫ßn tr∆∞·ªõc ƒë√≥: build_and_push job)

  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push 

    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      # C·∫•u h√¨nh AWS Credentials (Gi·ªØ nguy√™n)
      - name: üîë Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }} 

      - name: üöÄ Deploy to Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v21
        with:
          # ‚úÖ S·ª¨A L·ªñI 1: ƒê·ªïi t√™n tham s·ªë (aws_application_name -> application_name)
          application_name: todo-list-app-v2 
          environment_name: TodoListV2-env
          deployment_package: deploy.zip 
          
          # ‚úÖ S·ª¨A L·ªñI 2: TH√äM THAM S·ªê REGION
          region: ${{ secrets.AWS_REGION }} 
          
          # C·∫•u h√¨nh ƒë·ªÉ s·ª≠ d·ª•ng docker-compose.yml
          docker_compose: true 
          docker_compose_file: docker-compose.yml
